<!DOCTYPE html>
<html dir="rtl" lang="ar">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ø³Ø¨ÙŠÙ„ Ø§Ù„ØªÙÙˆÙ‚ | Ø£Ø³ØªØ§Ø° Ù…Ø­Ù…Ø¯ Ø­Ø§Ù…Ø¯</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, get, child, push, update, onValue, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        const firebaseConfig = {
            apiKey: 'AIzaSyDZ9y1XLS0wMR0kKdEOO91utF7-5p9vp_M',
            authDomain: 'sabeel-platform-official.firebaseapp.com',
            projectId: 'sabeel-platform-official',
            storageBucket: 'sabeel-platform-official.firebasestorage.app',
            messagingSenderId: '150583731393',
            appId: '1:150583731393:web:8c181e212832356af2e040',
            measurementId: 'G-65HE8PB0XT',
            databaseURL: 'https://sabeel-platform-official-default-rtdb.firebaseio.com'
        };
        const app = initializeApp(firebaseConfig);
        window.db = getDatabase(app);
        window.auth = getAuth(app);
        window.googleProvider = new GoogleAuthProvider();
        window.rtdb = { ref, set, get, child, push, update, onValue, remove, serverTimestamp };
        window.authMethods = { signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged };
    </script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            dark: '#0a0a0a',
                            card: '#171717',
                            primary: '#a1a1aa',
                            accent: '#e4e4e7',
                        }
                    },
                    fontFamily: { 'cairo': ['Cairo', 'sans-serif'] },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'slide-up': 'slideUp 0.8s ease-out',
                        'flip': 'flip 0.6s ease-in-out',
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-20px)' } },
                        slideUp: { '0%': { transform: 'translateY(30px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        flip: { '0%': { transform: 'rotateY(0deg)' }, '100%': { transform: 'rotateY(180deg)' } },
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap');

        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #171717;
            --text-primary: #fafafa;
            --text-secondary: #a1a1aa;
            --grid-color: rgba(255, 255, 255, 0.04);
            --glow-color: rgba(228, 228, 231, 0.12);
        }

        .light-mode {
            --bg-primary: #fafafa;
            --bg-secondary: #f4f4f5;
            --text-primary: #0a0a0a;
            --text-secondary: #52525b;
            --grid-color: rgba(0, 0, 0, 0.06);
            --glow-color: rgba(161, 161, 170, 0.15);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
            margin: 0;
            transition: all 0.3s ease;
        }

        .glass-panel {
            background: rgba(23, 23, 23, 0.85);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            border-radius: 16px;
        }

        .light-mode .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.08);
        }

        .glass-icon {
            background: linear-gradient(135deg, rgba(161, 161, 170, 0.25) 0%, rgba(82, 82, 91, 0.15) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(228, 228, 231, 0.3);
            border-radius: 12px;
            padding: 10px;
            box-shadow: 0 0 20px rgba(161, 161, 170, 0.2), inset 0 0 20px rgba(255, 255, 255, 0.03);
            transition: all 0.3s ease;
        }

        .glass-icon:hover {
            box-shadow: 0 0 30px rgba(228, 228, 231, 0.35), inset 0 0 25px rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }

        .btn-main {
            background: linear-gradient(135deg, #e4e4e7 0%, #a1a1aa 100%);
            color: #0a0a0a;
            font-weight: 800;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(228, 228, 231, 0.25);
        }

        .btn-main:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(228, 228, 231, 0.4);
        }

        .embed-wrapper {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            border-radius: 12px;
            background: #000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .embed-wrapper iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }

        .math-grid {
            background-image: linear-gradient(var(--grid-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
            background-size: 30px 30px;
        }

        .hero-glow {
            background: radial-gradient(circle at 50% 50%, var(--glow-color) 0%, transparent 50%);
        }

        .light-mode .hero-glow {
            background: radial-gradient(circle at 50% 50%, rgba(161, 161, 170, 0.1) 0%, rgba(250, 250, 250, 0.95) 50%);
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #fbbf24;
        }

        .theme-toggle button {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .theme-toggle button.active {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }

        .auth-dropdown {
            position: relative;
        }

        .auth-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 8px;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 100;
        }

        .auth-dropdown:hover .auth-menu,
        .auth-menu:hover {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .auth-menu button {
            width: 100%;
            padding: 12px 16px;
            text-align: right;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .auth-menu button:hover {
            background: rgba(59, 130, 246, 0.2);
        }

        .flashcard-container {
            perspective: 1000px;
        }

        .flashcard {
            position: relative;
            width: 100%;
            height: 200px;
            cursor: pointer;
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }

        .flashcard.flipped {
            transform: rotateY(180deg);
        }

        .flashcard-front,
        .flashcard-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
        }

        .flashcard-front {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.3) 0%, rgba(30, 41, 59, 0.9) 100%);
            border: 1px solid rgba(59, 130, 246, 0.4);
        }

        .flashcard-back {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.3) 0%, rgba(30, 41, 59, 0.9) 100%);
            border: 1px solid rgba(251, 191, 36, 0.4);
            transform: rotateY(180deg);
        }

        .locked-content {
            position: relative;
            overflow: hidden;
        }

        .locked-content::after {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lock-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }

        .rank-novice {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
        }

        .rank-advanced {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }

        .rank-legend {
            background: linear-gradient(135deg, #fbbf24 0%, #d97706 100%);
            color: #0f172a;
        }

        .quiz-option {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .quiz-option:hover {
            transform: translateX(-5px);
            border-color: #fbbf24;
        }

        .quiz-option.selected {
            background: rgba(251, 191, 36, 0.2);
            border-color: #fbbf24;
        }
    </style>
</head>

<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ğŸ” Security Constants
        const SUPER_ADMIN_EMAIL = 'marwansami2009@gmail.com';
        const SUPER_ADMIN_UID = 'O3NqanKElfVqOpilTTl4lME9m1q2';
        const ADMIN_SECRET_PASSWORD = '123456789';
        const MANAGER_PASSWORD = '01023456789';

        // ğŸ“± Contact Info
        const CONTACT_INFO = {
            whatsapp: 'https://wa.me/201000000000',
            facebook: 'https://facebook.com/yourpage',
            youtube: 'https://youtube.com/yourchannel',
            telegram: 'https://t.me/yourchannel',
            vodafoneNumber: '010xxxxxxxx',
            supportWhatsapp: 'https://wa.me/201000000000'
        };

        // ğŸ·ï¸ Platform Branding
        const PLATFORM_NAME = 'Ù…Ù†ØµØ© Ø³Ø¨ÙŠÙ„ Ø§Ù„ØªÙÙˆÙ‚';
        const PLATFORM_SHORT = 'Ø³Ø¨ÙŠÙ„ Ø§Ù„ØªÙÙˆÙ‚';
        const TEACHER_NAME = 'Ø£Ø³ØªØ§Ø° Ù…Ø­Ù…Ø¯ Ø­Ø§Ù…Ø¯';

        // ğŸ¨ Icon Component
        const Icon = ({ name, size = 20, className = '' }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); });
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        const GlassIcon = ({ name, size = 24, className = '' }) => (
            <div className={`glass-icon inline-flex items-center justify-center ${className}`}>
                <Icon name={name} size={size} />
            </div>
        );

        // ğŸ” Auth Dropdown (ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø²Ø§Ø¦Ø±)
        const AuthDropdown = ({ onSelect, onGoogleLogin }) => {
            const [isOpen, setIsOpen] = useState(false);
            return (
                <div className="auth-dropdown" onMouseEnter={() => setIsOpen(true)} onMouseLeave={() => setIsOpen(false)}>
                    <button className="bg-white/10 hover:bg-white/20 border border-white/20 px-6 py-2 rounded-full font-bold transition">
                        ØªØ³Ø¬ÙŠÙ„ / Ø¯Ø®ÙˆÙ„
                    </button>
                    <div className={`auth-menu ${isOpen ? 'opacity-100 visible translate-y-0' : ''}`}>
                        <button onClick={() => { onSelect('student'); onGoogleLogin(); }}>ğŸ‘¨ğŸ“ Ø·Ø§Ù„Ø¨</button>
                        <button onClick={() => { onSelect('parent'); onGoogleLogin(); }}>ğŸ‘¨ğŸ‘©ğŸ‘¦ ÙˆÙ„ÙŠ Ø£Ù…Ø±</button>
                    </div>
                </div>
            );
        };

        // ğŸ† Honor Board
        const HonorBoard = ({ students, isDarkMode }) => {
            const topStudents = students
                .filter(s => !['admin', 'boss'].includes(s.role))
                .map(s => ({ ...s, points: s.points || 0 }))
                .sort((a, b) => b.points - a.points)
                .slice(0, 10);

            return (
                <div className="glass-panel p-6 animate-slide-up">
                    <div className="flex items-center gap-3 mb-6">
                        <div className="glass-icon bg-gradient-to-r from-zinc-400/30 to-zinc-500/20 border-zinc-400">
                            <Icon name="award" size={24} className="text-zinc-300" />
                        </div>
                        <div>
                            <h2 className="text-xl font-bold">â™ ÙØ±Ø³Ø§Ù† Ø§Ù„ØªÙÙˆÙ‚</h2>
                            <p className="text-xs text-slate-400">Ø£ÙØ¶Ù„ 10 Ø·Ù„Ø§Ø¨ Ø¨Ø§Ù„Ù…Ù†ØµØ©</p>
                        </div>
                    </div>
                    <div className="space-y-3">
                        {topStudents.length === 0 ? (
                            <div className="text-center py-8 text-slate-400">
                                <p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ø¨Ø¹Ø¯</p>
                            </div>
                        ) : (
                            topStudents.map((student, index) => (
                                <div key={student.id} className="p-4 rounded-xl flex items-center gap-4 bg-white/5 border border-white/10">
                                    <div className="font-black text-lg text-yellow-500">#{index + 1}</div>
                                    <img src={student.photo} className="w-10 h-10 rounded-full" />
                                    <div className="flex-1">
                                        <p className="font-bold">{student.name}</p>
                                    </div>
                                    <div className="font-bold text-brand-accent">{student.points} Ù†</div>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            );
        };

        // ğŸ’³ Subscription Status
        const SubscriptionStatusCard = ({ user }) => {
            if (!user?.isPaid) return null;
            const endDate = new Date(user.subscriptionEnd);
            const daysLeft = Math.ceil((endDate - new Date()) / (1000 * 60 * 60 * 24));
            const isExpired = daysLeft <= 0;

            return (
                <div className="glass-panel p-6 mb-6 border-r-4 border-blue-500 relative overflow-hidden animate-slide-up">
                    <div className="relative z-10">
                        <h3 className="text-slate-400 text-sm font-bold mb-1 flex items-center gap-2">
                            <Icon name="credit-card" size={16} /> Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
                        </h3>
                        <div className="flex justify-between items-center">
                            <span className={`text-2xl font-black ${isExpired ? 'text-red-500' : 'text-green-400'}`}>
                                {isExpired ? 'Ù…Ù†ØªÙ‡ÙŠ' : 'Ù†Ø´Ø·'}
                            </span>
                            {!isExpired && <span className="text-xl font-bold text-white">{daysLeft} ÙŠÙˆÙ…</span>}
                        </div>
                    </div>
                </div>
            );
        };

        // ğŸ¯ Professional Exam Runner (Timer + Logic)
        const ProExamRunner = ({ exam, onClose, onSubmit }) => {
            const [currentQ, setCurrentQ] = useState(0);
            const [answers, setAnswers] = useState({});
            const [timeLeft, setTimeLeft] = useState(exam.duration ? exam.duration * 60 : 1800);
            const [showResult, setShowResult] = useState(false);
            const [score, setScore] = useState(0);

            useEffect(() => {
                if (showResult) return;
                const timer = setInterval(() => {
                    setTimeLeft((prev) => {
                        if (prev <= 1) {
                            clearInterval(timer);
                            handleSubmit();
                            return 0;
                        }
                        return prev - 1;
                    });
                }, 1000);
                return () => clearInterval(timer);
            }, [showResult]);

            const formatTime = (s) => `${Math.floor(s / 60)}:${(s % 60).toString().padStart(2, '0')}`;

            const handleSelect = (idx) => {
                setAnswers({ ...answers, [currentQ]: idx });
            };

            const handleSubmit = () => {
                let calcScore = 0;
                exam.questions.forEach((q, idx) => {
                    if (answers[idx] === q.correctIndex) calcScore++;
                });
                setScore(calcScore);
                setShowResult(true);
                if (onSubmit) onSubmit(calcScore, exam.questions.length);
            };

            if (showResult) {
                return (
                    <div className="fixed inset-0 z-[200] bg-brand-dark flex flex-col items-center justify-center p-4">
                        <div className="glass-panel p-8 max-w-lg w-full text-center">
                            <h2 className="text-3xl font-black mb-4">Ø§Ù„Ù†ØªÙŠØ¬Ø©</h2>
                            <p className="text-6xl font-black text-brand-accent mb-6">{score} / {exam.questions.length}</p>
                            <button onClick={onClose} className="btn-main w-full py-4 rounded-xl font-bold">Ø®Ø±ÙˆØ¬</button>
                        </div>
                    </div>
                );
            }

            if (!exam.questions || exam.questions.length === 0) return null;

            return (
                <div className="fixed inset-0 z-[200] bg-brand-dark flex flex-col">
                    <div className="h-16 border-b border-white/10 flex items-center justify-between px-4 bg-brand-card">
                        <div className="font-mono text-xl font-bold text-yellow-400">{formatTime(timeLeft)}</div>
                        <button onClick={onClose} className="text-red-400 font-bold">Ø§Ù†Ø³Ø­Ø§Ø¨</button>
                    </div>
                    <div className="flex-1 p-6 overflow-y-auto">
                        <h2 className="text-2xl font-bold mb-8">{exam.questions[currentQ].text}</h2>
                        <div className="space-y-3">
                            {exam.questions[currentQ].options.map((opt, idx) => (
                                <div key={idx} onClick={() => handleSelect(idx)}
                                    className={`p-4 rounded-xl border-2 cursor-pointer ${answers[currentQ] === idx ? 'border-brand-accent bg-brand-accent/10' : 'border-white/10'}`}>
                                    {opt}
                                </div>
                            ))}
                        </div>
                        <div className="flex justify-between mt-10">
                            <button disabled={currentQ === 0} onClick={() => setCurrentQ(p => p - 1)} className="px-6 py-2 bg-white/10 rounded-lg">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                            {currentQ === exam.questions.length - 1 ? (
                                <button onClick={handleSubmit} className="px-6 py-2 bg-green-600 text-white rounded-lg">Ø¥Ù†Ù‡Ø§Ø¡</button>
                            ) : (
                                <button onClick={() => setCurrentQ(p => p + 1)} className="px-6 py-2 btn-main rounded-lg">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // ğŸ“ Main App
        const App = () => {
            const [isDarkMode, setIsDarkMode] = useState(true);
            const [user, setUser] = useState(null);
            const [view, setView] = useState('loading');
            const [dataState, setDataState] = useState({ students: [], requests: [], lectures: [], exams: [] });
            const [regData, setRegData] = useState({ phone: '', parentPhone: '', school: '', governorate: '', city: '', grade: '1sec', accountType: 'student', firstName: '', fatherName: '', grandfatherName: '' });

            // UI States
            const [activeTab, setActiveTab] = useState('home');
            const [selectedLecture, setSelectedLecture] = useState(null);
            const [showExamRunner, setShowExamRunner] = useState(false);
            const [examToRun, setExamToRun] = useState(null);
            const [notification, setNotification] = useState(null);
            const [sidebarOpen, setSidebarOpen] = useState(false);

            const isAdmin = user && (user.role === 'admin' || user.role === 'boss');

            useEffect(() => {
                document.body.classList.toggle('light-mode', !isDarkMode);
            }, [isDarkMode]);

            const showNotification = (msg, type = 'success') => {
                setNotification({ msg, type });
                setTimeout(() => setNotification(null), 4000);
            };

            // Auth Listener
            useEffect(() => {
                const unsubscribe = window.authMethods.onAuthStateChanged(window.auth, async (u) => {
                    if (u) {
                        const userRef = window.rtdb.ref(window.db, `users/${u.uid}`);
                        window.rtdb.onValue(userRef, (snapshot) => {
                            if (snapshot.exists()) {
                                setUser({ ...snapshot.val(), uid: u.uid, photo: u.photoURL });
                                const role = snapshot.val().role;
                                setView(role === 'admin' || role === 'boss' ? 'admin' : 'student');
                            } else {
                                window.rtdb.get(window.rtdb.ref(window.db, `requests/${u.uid}`)).then(reqSnap => {
                                    if (reqSnap.exists()) {
                                        setUser({ ...reqSnap.val(), uid: u.uid });
                                        setView('waiting-approval');
                                    } else {
                                        setUser({ uid: u.uid, name: u.displayName, email: u.email, photo: u.photoURL });
                                        setView('complete-profile');
                                    }
                                });
                            }
                        });
                    } else {
                        setUser(null);
                        setView('landing');
                    }
                });
                return () => unsubscribe();
            }, []);

            // Data Sync
            useEffect(() => {
                if (user) {
                    ['lectures', 'exams', 'requests'].forEach(path => {
                        window.rtdb.onValue(window.rtdb.ref(window.db, path), s => {
                            setDataState(prev => ({
                                ...prev,
                                [path]: s.val() ? Object.entries(s.val()).map(([k, v]) => ({ id: k, ...v })) : []
                            }));
                        });
                    });
                    // Users â†’ students key
                    window.rtdb.onValue(window.rtdb.ref(window.db, 'users'), s => {
                        setDataState(prev => ({
                            ...prev,
                            students: s.val() ? Object.entries(s.val()).map(([k, v]) => ({ id: k, ...v })) : []
                        }));
                    });
                }
            }, [user]);

            // Handlers
            const handleGoogleLogin = () => window.authMethods.signInWithPopup(window.auth, window.googleProvider);

            const saveRequest = async () => {
                if (!regData.phone || !regData.firstName) return showNotification('Ø§ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                try {
                    const displayName = `${regData.firstName} ${regData.fatherName} ${regData.grandfatherName}`.trim();
                    await window.rtdb.set(window.rtdb.ref(window.db, `requests/${user.uid}`), {
                        ...regData,
                        uid: user.uid,
                        name: displayName,
                        displayName: displayName,
                        email: user.email,
                        photo: user.photo,
                        date: new Date().toLocaleDateString(),
                        ts: Date.now(),
                        requestType: regData.accountType || 'student'
                    });
                    showNotification('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
                    setView('waiting-approval');
                } catch (e) {
                    console.error(e);
                    showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£', 'error');
                }
            };

            const approveRequest = async (req) => {
                const userData = {
                    ...req,
                    role: 'student',
                    isPaid: false,
                    isNew: false,
                    code: `STD${Date.now().toString().slice(-6)}`
                };
                await window.rtdb.set(window.rtdb.ref(window.db, `users/${req.uid}`), userData);
                await window.rtdb.remove(window.rtdb.ref(window.db, `requests/${req.uid}`));
                showNotification('ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨');
            };

            const renderContent = (link) => {
                if (!link) return null;
                if (link.includes('youtu')) {
                    const id = link.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/)?.[2];
                    return <div className="embed-wrapper"><iframe src={`https://www.youtube.com/embed/${id}`} allowFullScreen></iframe></div>;
                }
                return <a href={link} target="_blank" className="block p-4 bg-white/10 text-center rounded-xl">ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·</a>;
            };

            // --- VIEWS ---

            // 1. Loading
            if (view === 'loading') return <div className="h-screen bg-brand-dark flex items-center justify-center text-white animate-pulse">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>;

            // 2. Landing
            if (view === 'landing') return (
                <div className={`min-h-screen text-white relative overflow-hidden math-grid flex flex-col ${isDarkMode ? 'bg-brand-dark' : 'bg-slate-50 text-slate-900'}`}>
                    <div className="absolute top-0 left-0 w-full h-full hero-glow z-0"></div>
                    <header className="p-6 flex justify-between items-center relative z-10">
                        <h1 className="text-2xl font-black">{PLATFORM_NAME}</h1>
                        <button onClick={handleGoogleLogin} className="btn-main px-6 py-2 rounded-full font-bold">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
                    </header>
                    <main className="flex-1 flex flex-col items-center justify-center text-center p-4 relative z-10">
                        <h1 className="text-5xl md:text-7xl font-black mb-6">Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© <br /><span className="text-brand-accent">Ù„Ø¹Ø¨ØªÙƒ Ù…Ø¹Ø§Ù†Ø§!</span></h1>
                        <p className="text-xl mb-8 text-slate-400">Ù…Ø¹ {TEACHER_NAME}.. Ø§Ù„Ù†Ø­Ùˆ ÙˆØ§Ù„Ø¨Ù„Ø§ØºØ© Ø£Ø³Ù‡Ù„ Ù…Ù…Ø§ ØªØªØ®ÙŠÙ„</p>
                        <button onClick={handleGoogleLogin} className="btn-main px-8 py-4 rounded-xl text-xl font-bold flex items-center gap-2">
                            Ø§Ø´ØªØ±Ùƒ Ø§Ù„Ø¢Ù† <Icon name="arrow-left" />
                        </button>
                    </main>
                </div>
            );

            // 3. Complete Profile
            if (view === 'complete-profile') return (
                <div className="min-h-screen bg-brand-dark flex items-center justify-center p-4">
                    <div className="glass-panel p-8 w-full max-w-lg animate-slide-up">
                        <h2 className="text-2xl font-bold text-white mb-6 text-center">Ø§Ø³ØªÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ ğŸ“</h2>
                        <div className="space-y-4">
                            <div className="flex gap-2 bg-white/5 p-1 rounded-xl">
                                <button onClick={() => setRegData({...regData, accountType: 'student'})} className={`flex-1 py-2 rounded-lg ${regData.accountType === 'student' ? 'bg-brand-primary text-white' : 'text-slate-400'}`}>Ø·Ø§Ù„Ø¨</button>
                                <button onClick={() => setRegData({...regData, accountType: 'parent'})} className={`flex-1 py-2 rounded-lg ${regData.accountType === 'parent' ? 'bg-brand-primary text-white' : 'text-slate-400'}`}>ÙˆÙ„ÙŠ Ø£Ù…Ø±</button>
                            </div>
                            <input className="w-full p-3 bg-white/5 border border-white/10 rounded-xl text-white" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„" onChange={e => setRegData({...regData, firstName: e.target.value})} />
                            <input className="w-full p-3 bg-white/5 border border-white/10 rounded-xl text-white" placeholder="Ø§Ø³Ù… Ø§Ù„Ø£Ø¨" onChange={e => setRegData({...regData, fatherName: e.target.value})} />
                            <input className="w-full p-3 bg-white/5 border border-white/10 rounded-xl text-white" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯" onChange={e => setRegData({...regData, grandfatherName: e.target.value})} />
                            <input className="w-full p-3 bg-white/5 border border-white/10 rounded-xl text-white" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" onChange={e => setRegData({...regData, phone: e.target.value})} />
                            <input className="w-full p-3 bg-white/5 border border-white/10 rounded-xl text-white" placeholder="Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±" onChange={e => setRegData({...regData, parentPhone: e.target.value})} />
                            <select className="w-full p-3 bg-black/30 border border-white/10 rounded-xl text-white" onChange={e => setRegData({...regData, grade: e.target.value})}>
                                <option value="1sec">Ø£ÙˆÙ„Ù‰ Ø«Ø§Ù†ÙˆÙŠ</option>
                                <option value="2sec">ØªØ§Ù†ÙŠØ© Ø«Ø§Ù†ÙˆÙŠ</option>
                                <option value="3sec">ØªØ§Ù„ØªØ© Ø«Ø§Ù†ÙˆÙŠ</option>
                            </select>
                            <button onClick={saveRequest} className="btn-main w-full py-3 rounded-xl font-bold mt-4">Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
                        </div>
                    </div>
                </div>
            );

            // 4. Waiting Approval
            if (view === 'waiting-approval') return (
                <div className="min-h-screen bg-brand-dark flex items-center justify-center p-4 text-center">
                    <div className="glass-panel p-10 border-t-4 border-yellow-500 animate-slide-up">
                        <div className="text-5xl mb-4">â³</div>
                        <h2 className="text-2xl font-bold text-white mb-2">Ø§Ù„Ø­Ø³Ø§Ø¨ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</h2>
                        <p className="text-slate-400 mb-6">ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­. Ø³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ø£Ø¯Ù…Ù† Ø¨ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹.</p>
                        <button onClick={() => window.location.reload()} className="px-6 py-2 bg-white/10 rounded-xl text-white">ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©</button>
                    </div>
                </div>
            );

            // 5. Dashboard (Student & Admin)
            return (
                <div className={`min-h-screen flex ${isDarkMode ? 'bg-brand-dark text-white' : 'bg-slate-50 text-slate-900'}`}>
                    {/* Sidebar */}
                    <aside className={`w-64 bg-brand-card border-l border-white/5 flex flex-col p-4 ${sidebarOpen ? 'fixed inset-y-0 right-0 z-50' : 'hidden md:flex'}`}>
                        <div className="text-center mb-8">
                            <div className="w-16 h-16 bg-brand-accent rounded-full mx-auto mb-2 flex items-center justify-center text-black font-bold text-2xl">
                                {user.name ? user.name.charAt(0) : '?'}
                            </div>
                            <h3 className="font-bold">{user.name}</h3>
                            <p className="text-xs text-slate-500">{isAdmin ? 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…' : 'Ø·Ø§Ù„Ø¨'}</p>
                        </div>
                        <nav className="space-y-2 flex-1">
                            <button onClick={() => setActiveTab('home')} className={`w-full flex items-center gap-3 p-3 rounded-xl ${activeTab === 'home' ? 'bg-brand-primary text-white' : 'hover:bg-white/5'}`}>
                                <Icon name="home" /> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                            </button>
                            <button onClick={() => {setActiveTab('lectures'); setSelectedLecture(null)}} className={`w-full flex items-center gap-3 p-3 rounded-xl ${activeTab === 'lectures' ? 'bg-brand-primary text-white' : 'hover:bg-white/5'}`}>
                                <Icon name="play-circle" /> Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª
                            </button>
                            {isAdmin && (
                                <>
                                    <button onClick={() => setActiveTab('requests')} className={`w-full flex items-center gap-3 p-3 rounded-xl ${activeTab === 'requests' ? 'bg-brand-primary text-white' : 'hover:bg-white/5'}`}>
                                        <Icon name="user-plus" /> Ø§Ù„Ø·Ù„Ø¨Ø§Øª {dataState.requests.length > 0 && <span className="bg-red-500 text-white text-xs px-2 rounded-full">{dataState.requests.length}</span>}
                                    </button>
                                    <button onClick={() => setActiveTab('exams')} className={`w-full flex items-center gap-3 p-3 rounded-xl ${activeTab === 'exams' ? 'bg-brand-primary text-white' : 'hover:bg-white/5'}`}>
                                        <Icon name="file-text" /> Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª
                                    </button>
                                </>
                            )}
                        </nav>
                        <button onClick={() => window.authMethods.signOut(window.auth)} className="flex items-center gap-2 text-red-400 mt-auto p-2">
                            <Icon name="log-out" /> Ø®Ø±ÙˆØ¬
                        </button>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 p-4 md:p-8 overflow-y-auto">
                        {/* Header Mobile */}
                        <div className="md:hidden flex justify-between items-center mb-6">
                            <h1 className="font-bold text-xl">{PLATFORM_NAME}</h1>
                            <button onClick={() => setSidebarOpen(!sidebarOpen)}><Icon name="menu" /></button>
                        </div>

                        {/* Views */}
                        {activeTab === 'home' && (
                            <div className="space-y-6 animate-slide-up">
                                <div className="bg-gradient-to-r from-blue-900 to-brand-card p-8 rounded-2xl relative overflow-hidden">
                                    <h2 className="text-3xl font-bold relative z-10">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒØŒ {user.name} ğŸ‘‹</h2>
                                    <p className="text-blue-200 relative z-10 mt-2">Ø§Ø³ØªØ¹Ø¯ Ù„Ù„ØªÙÙˆÙ‚ ÙÙŠ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©!</p>
                                </div>
                                <SubscriptionStatusCard user={user} />
                                <HonorBoard students={dataState.students} />
                            </div>
                        )}

                        {activeTab === 'lectures' && (
                            <div className="animate-slide-up">
                                {selectedLecture ? (
                                    <div className="space-y-6">
                                        <button onClick={() => setSelectedLecture(null)} className="flex items-center gap-2 text-slate-400 hover:text-white">
                                            <Icon name="arrow-right" /> Ø±Ø¬ÙˆØ¹
                                        </button>
                                        <div className="glass-panel overflow-hidden p-0">
                                            {renderContent(selectedLecture.link)}
                                            <div className="p-4">
                                                <h2 className="text-2xl font-bold">{selectedLecture.title}</h2>
                                                <p className="text-slate-400 mt-2">{selectedLecture.description}</p>
                                            </div>
                                        </div>

                                        {/* Action Cards */}
                                        <div className="grid md:grid-cols-2 gap-4">
                                            <div onClick={() => window.open(selectedLecture.homeworkLink || '#', '_blank')} className="glass-panel p-6 flex items-center justify-between cursor-pointer hover:border-blue-500 transition">
                                                <div className="flex items-center gap-4">
                                                    <div className="w-12 h-12 bg-blue-500/20 rounded-full flex items-center justify-center text-blue-400">
                                                        <Icon name="file-text" />
                                                    </div>
                                                    <div>
                                                        <h3 className="font-bold">Ù…Ù„Ø²Ù…Ø© Ø§Ù„ÙˆØ§Ø¬Ø¨</h3>
                                                        <p className="text-xs text-slate-400">ØªØ­Ù…ÙŠÙ„ PDF</p>
                                                    </div>
                                                </div>
                                                <Icon name="download" />
                                            </div>

                                            <div onClick={() => {
                                                if(selectedLecture.examId) {
                                                    setExamToRun(selectedLecture.examId);
                                                    setShowExamRunner(true);
                                                } else {
                                                    showNotification('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ù…ØªØ­Ø§Ù†', 'error');
                                                }
                                            }} className="glass-panel p-6 flex items-center justify-between cursor-pointer hover:border-red-500 transition">
                                                <div className="flex items-center gap-4">
                                                    <div className="w-12 h-12 bg-red-500/20 rounded-full flex items-center justify-center text-red-400">
                                                        <Icon name="clipboard" />
                                                    </div>
                                                    <div>
                                                        <h3 className="font-bold">Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ø­ØµØ©</h3>
                                                        <p className="text-xs text-slate-400">Ø§Ø®ØªØ¨Ø± Ù†ÙØ³Ùƒ Ø§Ù„Ø¢Ù†</p>
                                                    </div>
                                                </div>
                                                <div className="bg-red-500 text-white px-2 py-1 rounded text-xs">Ø§Ø¨Ø¯Ø£</div>
                                            </div>
                                        </div>
                                    </div>
                                ) : (
                                    <div>
                                        {isAdmin && (
                                            <div className="glass-panel p-6 mb-8">
                                                <h3 className="font-bold mb-4">Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ø§Ø¶Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
                                                <div className="grid gap-4">
                                                    <input id="lecTitle" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" className="p-3 bg-white/5 rounded-xl border border-white/10" />
                                                    <input id="lecLink" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ" className="p-3 bg-white/5 rounded-xl border border-white/10" />
                                                    <input id="lecHomework" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆØ§Ø¬Ø¨ PDF" className="p-3 bg-white/5 rounded-xl border border-white/10" />
                                                    <select id="lecExamId" className="p-3 bg-black/30 rounded-xl border border-white/10 text-white">
                                                        <option value="">Ø§Ø®ØªØ± Ø§Ù…ØªØ­Ø§Ù† Ù…Ø±ØªØ¨Ø·</option>
                                                        {dataState.exams.map(e => <option key={e.id} value={e.id}>{e.question}</option>)}
                                                    </select>
                                                    <button onClick={() => {
                                                        const title = document.getElementById('lecTitle').value;
                                                        const link = document.getElementById('lecLink').value;
                                                        const homeworkLink = document.getElementById('lecHomework').value;
                                                        const examId = document.getElementById('lecExamId').value;
                                                        if(title && link) {
                                                            window.rtdb.push(window.rtdb.ref(window.db, 'lectures'), {
                                                                title, link, homeworkLink, examId,
                                                                date: new Date().toLocaleDateString(),
                                                                grade: 'all'
                                                            });
                                                            showNotification('ØªÙ… Ø§Ù„Ù†Ø´Ø±');
                                                        }
                                                    }} className="btn-main py-3 rounded-xl font-bold">Ù†Ø´Ø± Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©</button>
                                                </div>
                                            </div>
                                        )}

                                        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                                            {dataState.lectures.map(lec => (
                                                <div key={lec.id} onClick={() => setSelectedLecture(lec)} className="glass-panel overflow-hidden cursor-pointer hover:border-brand-accent transition group">
                                                    <div className="h-40 bg-slate-900 flex items-center justify-center relative">
                                                        <Icon name="play-circle" size={48} className="text-white/50 group-hover:text-white transition" />
                                                    </div>
                                                    <div className="p-4">
                                                        <h3 className="font-bold text-lg mb-1">{lec.title}</h3>
                                                        <p className="text-xs text-slate-400">Ø§Ø¶ØºØ· Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©</p>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === 'requests' && isAdmin && (
                            <div className="space-y-4 animate-slide-up">
                                <h2 className="text-2xl font-bold mb-6">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ù„ØªØ­Ø§Ù‚ ({dataState.requests.length})</h2>
                                {dataState.requests.map(req => (
                                    <div key={req.id} className="glass-panel p-6 flex flex-col md:flex-row justify-between gap-4 border-r-4 border-yellow-500">
                                        <div className="flex gap-4">
                                            <img src={req.photo} className="w-14 h-14 rounded-full" />
                                            <div>
                                                <h3 className="font-bold text-lg">{req.name}</h3>
                                                <p className="text-slate-400">{req.email}</p>
                                                <div className="flex gap-2 mt-2">
                                                    <span className="bg-white/10 px-2 py-1 rounded text-xs">{req.grade}</span>
                                                    <span className="bg-white/10 px-2 py-1 rounded text-xs">{req.phone}</span>
                                                </div>
                                                {req.bio && <p className="mt-2 text-sm text-blue-200 bg-blue-900/20 p-2 rounded">"{req.bio}"</p>}
                                            </div>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={() => approveRequest(req)} className="bg-green-600 px-6 py-2 rounded-xl font-bold">Ù‚Ø¨ÙˆÙ„</button>
                                            <button onClick={() => window.rtdb.remove(window.rtdb.ref(window.db, `requests/${req.uid}`))} className="bg-red-600 px-6 py-2 rounded-xl font-bold">Ø±ÙØ¶</button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* Pro Exam Runner Modal */}
                        {showExamRunner && examToRun && (() => {
                            const exam = dataState.exams.find(e => e.id === examToRun);
                            if (!exam) return null;
                            const formattedExam = exam.questions ? exam : {
                                questions: [{ text: exam.question || "Question", options: (exam.options || []).map(o => typeof o === 'string' ? o : o.text), correctIndex: exam.correctIndex || 0 }],
                                duration: exam.duration || 30
                            };
                            return <ProExamRunner exam={formattedExam} onClose={() => { setShowExamRunner(false); setExamToRun(null); }} />;
                        })()}

                        {/* Notification Toast */}
                        {notification && (
                            <div className={`fixed bottom-8 left-1/2 -translate-x-1/2 px-6 py-3 rounded-xl shadow-2xl font-bold z-50 text-white flex items-center gap-2 ${notification.type === 'error' ? 'bg-red-600' : 'bg-green-600'}`}>
                                {notification.msg}
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>